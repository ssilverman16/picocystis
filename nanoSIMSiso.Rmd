---
title: "nanoSIMSiso"
date: "6/26/2021"
output: html_document
---

# N stable isotope probing

Consider a case of a population that is exposed to an isotopically enriched tracer (in our case, this is a $^{15}N $ Nitrogen source). The $^{15}N$ composition of newly enriched biomass will have a distinct isotope composition that reflects tracer addition -- $^{15}F_{B_{new}}$. We can use mass balance between the newly produced and original biomass to determine the overall isotopic composition of biomass at time t:

$$
^{15}F_B (t) = \frac{B_{new}}{B} \cdot \space ^{15}{B_{new}} + \frac{B_{original}}{B} \cdot \space ^{15}F_{B_{original}}
$$
The terms containing $B_{new}$ and $B_{original}$ represent the mass fractions of new and original biomass, respectively.


In the (simplified) case where new biomass mirrors the isotopic composition of the tracer solution (labeled N), we can assume that $^{15}F_{B_{new}} = ^{15}F_{w_{spiked}}$, where $^{15}F_{w_{spiked}}$ is the fractional abundance of $^{15}N$ in the tracer solution.

To calculate apparent turnover time:

$$
F_T = a \cdot F_L \left(1-e^{-\mu\cdot t}\right) + F_{0} \cdot e^{-\mu \cdot t} \\
\downarrow \\
solve \space for \space \mu \\
\downarrow \\
\mu = \frac{1}{t} \cdot \ln\frac{(F_T - a*F_L)}{(F_0 - a*F_L)}
$$
$$
N_t = N_0 \cdot e^{µt} \\
\downarrow \\
\frac{ln(2)}{µ} = t
$$


# Load Libraries

```{r}
library(tidyverse)
library(readxl)
library(ggsci)
library(ggdist)
library(latex2exp)
```

# Import Data and Set Constants

```{r, message=FALSE}
roi_tbl <- read_tsv("roi_tbl.tsv")
a = 0.5 # EDIT: assimilation efficiency
f_l =  1 # EDIT: Labeling strength as 15N frac abundance
t_d = 4 # labeling time in days
nat_abund_15N = .00364 # EDIT: Natural abundance of target isotope 15N frac abundance
f_0 = .00364 # EDIT: Initial Isotopic enrichment 15N frac abundance
```

# FT calculations

Define a function gencalc that calculates growth rate based on assimilation efficiency (a), tracer strength (f_t), initial isotopic enrichment (f_0), label strength (f_l), and incubation time in days (t_d). Returns a growth rate in days.
```{r}
gencalc <- function(a, f_t, f_0, f_l, t_d) {
  case_when(
    t_d == 0 ~ NA_real_,
    TRUE ~ - (1/t_d) * (log((f_t - a*f_l)/(f_0 - a*f_l)))
  )
}
```

```{r}
# Calcilate Generation Times
roi_tbl <- roi_tbl %>% mutate(
  mu_d = gencalc(a, Ratio_15N_12Cx14N_12C, f_0, f_l, t_d),
  gen_d = log(2) / mu_d,
)

# Replace negative values with zeros
# If a cell is below natural abundance it will have a "negative" growth rate!
roi_tbl$mu_d[roi_tbl$mu_d < 0] <- 0
roi_tbl$gen_d[roi_tbl$gen_d < 0] <- 0

write_tsv(roi_tbl, "roi_tbl_gentimes.tsv")
```


# Plot

```{r}
p_turnover_nh4 <- roi_tbl %>% filter(N_source == "NH4") %>% 
  ggplot(aes(x = N_source, y = gen_d, color = cell_type)) +
  geom_boxplot(outlier.shape = NA) +
   geom_point(position=position_jitterdodge(jitter.width = 0.1), size = 0.2) +
  facet_wrap(vars(light), scales="free_y") +
  ylab(TeX("Cell Turnover $d^{-1}$")) +
  xlab("") +
  ggtitle("Cell gen time supplied with Ammonium") +
  scale_color_aaas() +
  coord_cartesian(ylim =c(0, 15)) +
  theme_classic()
p_turnover_nh4

roi_tbl %>% filter(N_source == "NH4") %>% filter(light == "light") %>% filter(gen_d < 15) 
```

```{r}
roi_tbl %>%
  filter(!is.na(gen_d)) %>% 
  filter(N_source %in% c("no3", "NH4")) %>% 
  ggplot(aes(x = N_source, y = mu_d, color = cell_type)) + 
  #facet_wrap(vars(N_source, light), scale = "free_x") +
  geom_boxplot(outlier.shape = NA) +
  geom_point(position=position_jitterdodge(jitter.width = 0.1), size = 0.2) +
  facet_wrap(vars(light, N_source), scales = "free") +
  ylab(TeX("Cell Turnover $d^{-1}$")) +
  scale_color_aaas() +
  theme_classic()
```





```{r}
roi_tbl %>% filter(cell_type_other == "Picocystis") %>% 
  ggplot(aes(x = mu_d, y = N_source)) +
  stat_halfeye()
```



```{r}

med_mu <- roi_tbl %>% filter(
  N_source == "NH4",
  light == "light",
  cell_type_other == "Picocystis"
)
median(med_mu$Ratio_15N_12Cx14N_12C)
t = - log((0.03154381 - a*f_l)/ (f_0-a*f_l)) / 0.3872494


```








